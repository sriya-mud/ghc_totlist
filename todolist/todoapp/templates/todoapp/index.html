

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>To-Do & Finance Returns</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!--link rel="stylesheet" href="{% static 'style.css' %}"-->
  <style>
      body {
          background-color: #f0f2f5;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .container {
          max-width: 950px;
          margin-top: 50px;
          background: white;
          padding: 30px;
          border-radius: 15px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
          display:flex;
          flex-direction: column;
        
      }

      h2 {
          font-weight: 700;
          margin-bottom: 25px;
      }

      /* Navbar Tabs */
      .nav-tabs .nav-link {
          font-weight: bold;
          color: #495057;
          border: none;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
      }
      .nav-tabs .nav-link.active {
          border-bottom: 3px solid #007bff;
          color: #007bff;
      }

      /* To-Do Inputs */
      .todo-input {
          width: 200px;
          margin-right: 10px;
          border-radius: 8px;
          border: 1px solid #ced4da;
          padding: 6px 10px;
      }
      .btn-primary {
          border-radius: 8px;
          padding: 6px 20px;
          font-weight: 600;
      }

      /* Update/Delete buttons */
      .btn-update {
          background-color: #28a745;
          color: white;
          border-radius: 6px;
      }
      .btn-update:hover { background-color: #218838; color: white; }
      .btn-delete {
          background-color: #dc3545;
          color: white;
          border-radius: 6px;
      }
      .btn-delete:hover { background-color: #c82333; color: white; }

      /* Finance Tables */
      table.finance-table {
          border-collapse: collapse;
          margin-bottom: 30px;
          width: 100%;
      }
      table.finance-table th, table.finance-table td {
          border: 1px solid #dee2e6;
          padding: 12px;
          text-align: center;
      }
      table.finance-table th {
          background-color: #e9ecef;
          font-weight: 600;
      }
      .finance-table td.positive {
          color: #198754;
          font-weight: bold;
      }
      .finance-table td.negative {
          color: #dc3545;
          font-weight: bold;
      }
      
     /* =======================
   Data Analysis Tab Styling
======================= */

/* Remove extra styling from #data; inherit container */
#data {
    padding: 20px 0;
    background: inherit;
    border-radius: inherit;
    box-shadow: none;
}

/* Heading */
#data h3 {
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 25px;
    text-align: center;
}

/* Dropdown */
#taskSelect {
    font-size: 1rem;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    transition: all 0.3s ease;
    text-align: center;
}

#taskSelect:hover,
#taskSelect:focus {
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0,123,255,0.5);
}

/* Tables Container */
#tablesContainer {
    width: 100%;
    max-width: 900px;  /* align with container */
    overflow-x: auto;
    margin-top: 20px;
}

/* Tables */
#tablesContainer table {
    width: 100%;
    border-radius: 10px;
    border-collapse: collapse;
    box-shadow: 0 3px 8px rgba(0,0,0,0.05);
    margin-bottom: 25px;
    text-align: center;
    border: 1px solid black;
}

/* Table headers */
#tablesContainer th {
    background: #007bff;
    color: #fff;
    font-weight: 600;
    padding: 10px;
    border: 1px solid black;
    
}

/* Table cells */
#tablesContainer td {
    padding: 10px;
    font-weight: 500;
    color: #333;
    border: 1px solid black;
}

/* Striped rows */
#tablesContainer tbody tr:nth-child(even) {
    background-color: #f2f7ff;
}

/* Hover effect */
#tablesContainer tbody tr:hover {
    background-color: #e6f0ff;
    transition: background 0.3s;
}

/* Chart */
#taskChart {
    width: 100%;
    max-width: 900px;
    margin: 0 auto 20px auto;
    border-radius: 12px;
    background: #fff;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* Alert */
#data .alert-info {
    font-size: 0.9rem;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 20px;
    padding: 10px 15px;
}

/* Responsive */
@media (max-width: 768px) {
    #taskSelect {
        width: 100%;
    }

    #tablesContainer table,
    #taskChart {
        max-width: 100%;
    }
}

/* =======================
   Graphs Tab Styling
======================= */

/* Main Graphs Section â€” aligned same as Data Analysis tab */
#graphs {
    margin-top: 0 !important;      /* ensures no top gap */
    padding: 30px 40px 40px 40px;  /* top, right, bottom, left */
    background-color: #f8f9fa;     /* consistent background */
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    width: 100%;
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
    box-sizing: border-box;
}


/* Heading */
#graphs h3 {
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 25px;
    text-align: center;
    letter-spacing: 0.5px;
}

/* Dropdown Wrapper (centered) */
.graph-select-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 25px;
}

/* Dropdown */
#graphSelect {
    font-size: 1rem;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
    background-color: #fff;
    transition: all 0.3s ease;
    cursor: pointer;
}

#graphSelect:hover,
#graphSelect:focus {
    border-color: #007bff;
    box-shadow: 0 0 6px rgba(0,123,255,0.4);
    outline: none;
}

/* Graph Container */
#graphContainer {
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    border-radius: 12px;
    background: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

/* Canvas inside graph container */
#graphContainer canvas {
    width: 100% !important;
    height: auto !important;
    border-radius: 10px;
}

/* Subtle hover effect */
#graphContainer:hover {
    box-shadow: 0 6px 18px rgba(0,0,0,0.15);
}

/* Info alert (e.g., "Select a graph type") */
#graphs .alert-info {
    font-size: 0.9rem;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 20px;
    padding: 12px 15px;
}

/* Ensure Graphs tab touches navbar */
.navbar {
    margin-bottom: 0 !important;
}

.tab-content {
    padding-top: 0 !important;
    margin-top: 0 !important;
}

#graphs.tab-pane {
    margin-top: 0 !important;
    padding-top: 0 !important;
}


/* Responsive Design */
@media (max-width: 768px) {
    #graphs {
        padding: 20px;
    }

    #graphSelect {
        width: 100%;
    }

    #graphContainer {
        max-width: 100%;
        padding: 12px;
    }
}

  </style>
</head>
<body>
<div class="container">
    <h2 style="text-align:center;"> To-Do & Finance Dashboard</h2>

    <!-- Navbar -->
    <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="todo-tab" data-bs-toggle="tab" data-bs-target="#todo" type="button" role="tab">To-Do List</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="finance-tab" data-bs-toggle="tab" data-bs-target="#finance" type="button" role="tab">Finance Returns</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">Data Analysis</button>
        </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="graphs-tab" data-bs-toggle="tab" data-bs-target="#graphs" type="button" role="tab">Graphs</button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- To-Do List Tab -->
        <div class="tab-pane fade show active" id="todo" role="tabpanel">
            <!-- Add Task Form -->
            <form method="POST" class="d-flex justify-content-start mb-4">
                {% csrf_token %}
                {{ form.task }}
                {{ form.date }}
                <button type="submit" class="btn btn-primary">Add Task</button>
            </form>

            <!-- Tasks Table -->
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>No.</th>
                        <th>Todo Item</th>
                        <th>Date</th>
                        <th>Update</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tasks %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ t.task }}</td>
                        <td>{{ t.date }}</td>
                        <td><a href="{% url 'update_task' t.id %}" class="btn btn-update btn-sm">Update</a></td>
                        <td><a href="{% url 'delete_task' t.id %}" class="btn btn-delete btn-sm">Delete</a></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5">No tasks yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Finance Returns Tab -->
        <div class="tab-pane fade" id="finance" role="tabpanel">
            {% for period, result in stock_data.items %}
                <h4 class="mt-4">{{ period }}</h4>
                <table class="finance-table table table-striped">
            <thead>
                <tr>
                    <th colspan="2">Top Gainers</th>
                    <th colspan="2">Top Losers</th>
                </tr>
                <tr>
                    <th>Ticker</th>
                    <th>Value (%)</th>
                    <th>Ticker</th>
                    <th>Value (%)</th>
                </tr>
            </thead>
                    <tbody>
                     {% for g, l in result.gainers_losers %}
                        <tr>
                            <!--Top gainers-->
                            {% if g %}
                            <td>{{ g.0 }}</td>
                            <td class="{% if g.1 >= 0 %}positive{% else %}negative{% endif %}">{{ g.1|floatformat:2 }}%</td>
                             {% else %}
                                <td></td><td></td>
                            {% endif %}
                            <!--Top losers-->
                            {% if l %}
                            <td>{{ l.0 }}</td>
                            <td class="{% if l.1 >= 0 %}positive{% else %}negative{% endif %}">{{ l.1|floatformat:2 }}%</td>
                            {% else %}
                                <td></td><td></td>
                            {% endif %}
                        </tr>
                      {% endfor %}
                    </tbody>

                </table>
            {% endfor %}
        </div>
    
    <!--Data analysis tab-->

<div class="tab-pane fade" id="data" role="tabpanel">
    
  <!--h3 class="text-center mt-3"> Data Analysis</h3-->

  <!-- Dropdown -->
  <div class="text-center mb-3">
    <select id="taskSelect" class="form-select w-25 mx-auto">
      <option value="" selected disabled>Select Task</option>
      <option value="task1">Task 1 </option>
      <option value="task2">Task 2 </option>
      <option value="task3">Task 3 </option>
    </select>
  </div>

  <!-- Tables -->
  <div id="tablesContainer" class="table-responsive">

    <!-- Task 1 Table -->
    <table id="tableTask1" class="table table-striped d-none">
      <thead>
        <tr><th>Month</th><th>Value</th></tr>
      </thead>
      <tbody>
        <tr><td>Jan</td><td>12</td></tr>
        <tr><td>Feb</td><td>18</td></tr>
        <tr><td>Mar</td><td>25</td></tr>
        <tr><td>Apr</td><td>20</td></tr>
        <tr><td>May</td><td>27</td></tr>
        <tr><td>Jun</td><td>30</td></tr>
        <tr><td>Jul</td><td>28</td></tr>
        <tr><td>Aug</td><td>35</td></tr>
        <tr><td>Sep</td><td>31</td></tr>
        <tr><td>Oct</td><td>40</td></tr>
      </tbody>
    </table>

    <!-- Task 2 Table -->
    <table id="tableTask2" class="table table-striped d-none">
      <thead>
        <tr><th>Product</th><th>Value</th></tr>
      </thead>
      <tbody>
        <tr><td>Product A</td><td>50</td></tr>
        <tr><td>Product B</td><td>65</td></tr>
        <tr><td>Product C</td><td>55</td></tr>
        <tr><td>Product D</td><td>70</td></tr>
        <tr><td>Product E</td><td>60</td></tr>
        <tr><td>Product F</td><td>80</td></tr>
        <tr><td>Product G</td><td>75</td></tr>
        <tr><td>Product H</td><td>90</td></tr>
        <tr><td>Product I</td><td>85</td></tr>
        <tr><td>Product J</td><td>95</td></tr>
      </tbody>
    </table>

    <!-- Task 3 Table -->
    <table id="tableTask3" class="table table-striped d-none">
      <thead>
        <tr><th>X</th><th>Y</th></tr>
      </thead>
      <tbody>
        <tr><td>1</td><td>5</td></tr>
        <tr><td>2</td><td>8</td></tr>
        <tr><td>3</td><td>6</td></tr>
        <tr><td>4</td><td>10</td></tr>
        <tr><td>5</td><td>9</td></tr>
        <tr><td>6</td><td>13</td></tr>
        <tr><td>7</td><td>11</td></tr>
        <tr><td>8</td><td>15</td></tr>
        <tr><td>9</td><td>14</td></tr>
        <tr><td>10</td><td>18</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Chart -->
  <canvas id="taskChart" height="150"></canvas>
   </div>


<!-- Graphs Tab -->
<div class="tab-pane fade" id="graphs" role="tabpanel">

  <div class="graph-select-wrapper">
      <select id="graphSelect" class="form-select w-25 mx-auto">
          <option value="" selected disabled>Select Graph</option>
          <option value="graph1">Graph 1 </option>
          <option value="graph2">Graph 2 </option>
          <option value="graph3">Graph 3 </option>
      </select>
  </div>

  <div id="graphContainer" class="table-responsive">
      <canvas id="graphChart" height="150"></canvas>
      <canvas id="graphChart2" height="150" class="d-none mt-4"></canvas>
  </div>
  </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Data Analysis Tab Script -->
<script>
let chartInstance = null;

document.getElementById('taskSelect').addEventListener('change', function() {
  const task = this.value;
  const tables = ['tableTask1', 'tableTask2', 'tableTask3'];
  
  // Hide all tables
  tables.forEach(id => document.getElementById(id).classList.add('d-none'));
  
  // Destroy old chart if exists
  if (chartInstance) chartInstance.destroy();

  // Show selected table
  const tableId = `table${task.charAt(0).toUpperCase() + task.slice(1)}`;
  const selectedTable = document.getElementById(tableId);
  selectedTable.classList.remove('d-none');

  // Extract data from table
  const rows = Array.from(selectedTable.querySelectorAll('tbody tr'));
  const labels = rows.map(r => r.cells[0].textContent.trim());
  const values = rows.map(r => parseFloat(r.cells[1].textContent.trim()));

  let type, data, options = {};

  if (task === 'task1') {
    type = 'line';
    data = {
      labels,
      datasets: [{
        label: 'Monthly Values',
        data: values,
        borderColor: 'blue',
        fill: true,
        tension: 0.3,
        backgroundColor: 'rgba(0,0,255,0.2)'
      }]
    };
  } 
  else if (task === 'task2') {
    type = 'bar';
    data = {
      labels,
      datasets: [{
        label: 'Product Values',
        data: values,
        backgroundColor: 'green'
      }]
    };
  } 
  else if (task === 'task3') {
    type = 'scatter';
    const points = rows.map(r => ({
      x: parseFloat(r.cells[0].textContent.trim()),
      y: parseFloat(r.cells[1].textContent.trim())
    }));
    data = {
      datasets: [{
        label: 'Scatter Points',
        data: points,
        backgroundColor: 'red'
      }]
    };
    options = {
      scales: {
        x: { title: { display: true, text: 'X Axis' } },
        y: { title: { display: true, text: 'Y Axis' } }
      }
    };
  }

  // Draw new chart
  chartInstance = new Chart(document.getElementById('taskChart'), { type, data, options });
});
</script>

<!-- Graphs Tab Script -->

{{ analysis1_data|json_script:"analysis1-data" }}
{{ analysis2_data|json_script:"analysis2-data" }}
{{ analysis3_data|json_script:"analysis3-data" }}

<script>

let graphChartInstance = null;
let graphChart2Instance = null;

// Load data safely
function safeParse(id) {
    try {
        return JSON.parse(document.getElementById(id).textContent);
    } catch (e) {
        console.warn(id + " not found or invalid:", e);
        return null;
    }
}

const analysis1Data = safeParse('analysis1-data');
const analysis2Data = safeParse('analysis2-data');
const analysis3Data = safeParse('analysis3-data');

document.getElementById('graphSelect').addEventListener('change', function () {
    const graph = this.value;
    if (graphChartInstance) graphChartInstance.destroy();
    if(graphChart2Instance) graphChart2Instance.destroy();

    const ctx2 = document.getElementById('graphChart2');
    ctx2.classList.add('d-none'); // hide by default

    // ðŸ‘‰ Call independent function for selected graph
    switch (graph) {
        case 'graph1':
            renderGraph1();
            break;
        case 'graph2':
            renderGraph2();
            break;
        case 'graph3':
            renderGraph3();
            break;
        default:
            alert("Please select a graph.");
    }
});

function renderGraph1() {
    if (!analysis1Data) return alert("Graph 1 data not found.");

    const ctx = document.getElementById('graphChart');
    const data = {
        labels: analysis1Data.labels,
        datasets: [
            {
                label: 'Close Price',
                data: analysis1Data.close_values,
                borderColor: 'blue',
                backgroundColor: 'rgba(0,0,255,0.2)',
                fill: false,
                tension: 0.3
            },
            {
                label: '7-Day Moving Average',
                data: analysis1Data.ma_values,
                borderColor: 'orange',
                backgroundColor: 'rgba(255,165,0,0.2)',
                borderDash: [5, 5],
                fill: false,
                tension: 0.3
            }
        ]
    };

    const options = {
        responsive: true,
        plugins: {
            title: { display: true, text: 'Stock Close vs 7-Day MA' },
            legend: { position: 'top' }
        },
        scales: {
            x: { title: { display: true, text: 'Date' } },
            y: { title: { display: true, text: 'Price' } }
        }
    };

    graphChartInstance = new Chart(ctx, { type: 'line', data, options });
}

function renderGraph2() {
    if (!analysis2Data) return alert("Graph 2 data not found.");

    const ctx = document.getElementById('graphChart');
    const colors = analysis2Data.values.map(v => (v >= 0 ? 'green' : 'red'));

    const data = {
        labels: analysis2Data.labels,
        datasets: [{
            label: 'MSFT Diff',
            data: analysis2Data.values,
            backgroundColor: colors
        }]
    };
    const options = {
        responsive: true,
        plugins: {
            title: { display: true, text: 'MSFT Diff' },
            legend: { position: 'top' }
        },
        scales: {
            x: { title: { display: true, text: 'Date' } },
            y: { title: { display: true, text: 'Difference' } }
        }
    };

    graphChartInstance = new Chart(ctx, { type: 'bar', data, options });
}

function renderGraph3() {
    if (!analysis3Data) return alert("Graph 3 data not found.");

    const closeData=analysis3Data.close_vs_return;
    if (!closeData || !closeData.labels.length) return alert("No data available for Graph 3.");
    const ctx = document.getElementById('graphChart');
    const data1 = {
        labels: analysis3Data.labels,
        datasets: [
            {
                label: 'Close',
                data: closeData.close,
                borderColor: 'blue',
                fill: false,
                tension: 0.3
            }
        ]
    };

    const options1 = {
        responsive: true,
        plugins: {
            title: { display: true, text: 'Date vs Close' },
            legend: { position: 'top' }
        },
        scales: {
            x: { title: { display: true, text: 'Date' } },
            y: { title: { display: true, text: 'Close Price' } }
        }
    };

    if (graphChartInstance) graphChartInstance.destroy();
    graphChartInstance = new Chart(ctx, { type: 'line', data:data1, options:options1 });

   

    const ctx2 = document.getElementById('graphChart2');
    ctx2.classList.remove('d-none'); // show only for graph3
    const colors = closeData.close_return.map(v => (v >= 0 ? 'green' : 'red'));
    const data2 = {
        labels: analysis3Data.labels,
        datasets: [
            {
                label: 'Close_Return(%)',
                data: closeData.close_return,
                borderColor: 'green',
                backgroundColor: colors,
                fill: false,
                tension: 0.3
            }
        ]
    };

    const options2 = {
        responsive: true,
        plugins: {
            title: { display: true, text: 'Date vs Close_Return% ' },
            legend: { position: 'top' }
        },
        scales: {
            x: { title: { display: true, text: 'Date' } },
            y: { title: { display: true, text: 'Close Return(%)' } }
        }
    };

    if (graphChart2Instance) graphChart2Instance.destroy();
    graphChart2Instance=new Chart(ctx2, { type: 'bar', data: data2, options: options2 });
  
}



function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}


</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

